import{collection as u,getDocs as m,query as y,orderBy as S,documentId as f,limit as U,onSnapshot as q,doc as b,getDoc as w,where as h}from"https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";import{d as a}from"./firebaseConfig-HqSgYK5z.js";let g=!1;const I=async(n,t,e,s)=>{const c=new Date(`${t}T${e}:59`),p=new Date(`${t}T${s}:59`),o=c.getTime(),r=p.getTime(),l=u(a,"ecg_data",n,"readings"),T=y(l,h(f(),">=",o.toString()),h(f(),"<=",r.toString())),R=await m(T),D=[];try{return R.forEach(d=>{const i=d.data();D.push({docId:d.id,ecgData:i.ecg_data,rrIntervals:i.rr_intervals,bpm:i.bpm,sdnn:i.sdnn,rmssd:i.rmssd})}),D}catch(d){console.error("Error fetching ECG data:",d)}},L=async n=>{const t=b(a,"UserAuthList",n),e=await w(t);return e.exists()?e.data():null},_=async()=>{const n=u(a,"UserAuthList"),t=await m(n),e=[];return t.forEach(s=>{s.data().Role==="User"&&e.push({...s.data()})}),e},v=async(n,t)=>{const e=b(a,"ecg_data",n,"readings",t),s=await w(e);return s.exists()?s.data():null};function x(n,t){return new Promise(e=>{n.data.setAll(t),n.appear(),setTimeout(e,10500)})}const E=async(n,t)=>{if(t.length===0||g===!0)return;g=!0;const e=t.shift();if(!e||e.length===0){isProcessing=!1;return}for(let s=0;s<e.length;s=s+1e3)await x(n,e.slice(s,s+1e3));g=!1,t.length>0&&E(n,t)},A=async(n,t)=>{const e=u(a,"ecg_data",t,"readings"),s=y(e,S(f(),"desc"),U(1));let c=[];return q(s,e,async o=>{const r=o.docs[0];if(r){const l=r.data();new Date().getTime()-r.id<=1.5*60*1e3?(document.getElementById("lastBatchText").innerHTML="",c.push(l.ecg_data),E(n,c)):document.getElementById("lastBatchText").innerHTML=`The last ECG reading for this user was captured at <b> ${new Date(Number(r.id))} </b>
        <br> If you connected your device, please wait around one minute to see the live data.`}else{alert("No data available for this user!");return}},o=>{console.error("Error subscribing to ECG readings:",o)})},P=async n=>{try{const t=u(a,"UserAuthList"),e=y(t,h("CNP","==",n)),s=await m(e);return s.empty?(alert("The pacient name is not correct!"),null):s.docs[0].id}catch(t){console.error("Error fetching documents:",t)}};export{v as a,_ as b,I as c,L as f,P as g,A as s};
